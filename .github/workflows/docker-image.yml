# GitHub Actions å·¥ä½œæµï¼šæ„å»ºå¹¶æ¨é€ Docker é•œåƒ
name: CI/CD - Build and Push Docker Image

# è§¦å‘å·¥ä½œæµçš„äº‹ä»¶
on:
  push:
    branches: [ "main" ] # ä»…åœ¨ä¸»åˆ†æ”¯ä¸Šæ¨é€æ—¶è§¦å‘
    tags: [ 'v*.*.*' ]     # åœ¨æ¨é€ç‰ˆæœ¬æ ‡ç­¾æ—¶è§¦å‘
  pull_request:
    branches: [ "main" ] # åœ¨å‘ä¸»åˆ†æ”¯å‘èµ· PR æ—¶è§¦å‘

# å¹¶å‘æ§åˆ¶ï¼šç¡®ä¿åŒä¸€åˆ†æ”¯/PRåªè¿è¡Œæœ€æ–°çš„å·¥ä½œæµï¼Œè‡ªåŠ¨å–æ¶ˆæ—§çš„è¿è¡Œ
concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

jobs:
  build-and-push-image:
    name: Build and Push Image
    runs-on: ubuntu-latest
    # ä¸ºä½œä¸šè®¾ç½®æƒé™ï¼Œä»¥å…è®¸å…¶æ¨é€åˆ° GitHub Packages å’Œä¸Šä¼ å®‰å…¨æŠ¥å‘Š
    permissions:
      contents: read
      packages: write
      security-events: write # ä¸Šä¼  Trivy å®‰å…¨æ‰«æç»“æœæ‰€éœ€

    steps:
      # 1. ç­¾å‡ºä»£ç 
      - name: â¬‡ï¸ Checkout Repository
        uses: actions/checkout@v4

      # 2. ç™»å½•åˆ° GitHub Container Registry (GHCR)
      - name: ğŸ”‘ Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 3. æå– Docker é•œåƒçš„å…ƒæ•°æ®ï¼ˆæ ‡ç­¾å’Œæ ‡æ³¨ï¼‰
      - name: ğŸ·ï¸ Extract Docker Metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}
          tags: |
            # ä¸ºæ¨é€åˆ°ä¸»åˆ†æ”¯çš„æ„å»ºæ·»åŠ  'latest' æ ‡ç­¾
            type=raw,value=latest,enable={{is_default_branch}}
            # ä¸ºè¯­ä¹‰åŒ–ç‰ˆæœ¬æ ‡ç­¾ (å¦‚ v1.2.3) åˆ›å»ºå¤šçº§æ ‡ç­¾ (1.2.3, 1.2)
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            # ä¸ºåˆ†æ”¯æ¨é€æ·»åŠ åˆ†æ”¯åæ ‡ç­¾
            type=ref,event=branch
            # ä¸º PR æ·»åŠ  'pr-NUMBER' æ ‡ç­¾
            type=ref,event=pr
            # æ·»åŠ çŸ­æ ¼å¼çš„ git SHA ä½œä¸ºæ ‡ç­¾ï¼Œç”¨äºç²¾ç¡®è¿½æº¯
            type=sha,prefix=,format=short

      # 4. è®¾ç½® QEMUï¼Œä»¥æ”¯æŒå¤šå¹³å°æ„å»º
      - name: ğŸ—ï¸ Set up QEMU for Multi-Platform Builds
        uses: docker/setup-qemu-action@v3

      # 5. è®¾ç½® Docker Buildxï¼Œä½¿ç”¨æ›´é«˜çº§çš„æ„å»ºåŠŸèƒ½
      - name: ğŸ› ï¸ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 6. æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
      - name: ğŸ“¦ Build and Push Docker Image
        id: build-and-push
        uses: docker/build-push-action@v5
        with:
          context: .
          # æ”¯æŒæ„å»º amd64 å’Œ arm64 ä¸¤ç§æ¶æ„çš„é•œåƒ
          platforms: linux/amd64,linux/arm64
          # ä»…åœ¨é PR äº‹ä»¶ä¸­æ¨é€åˆ°é•œåƒä»“åº“
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          # ä½¿ç”¨ GitHub Actions ç¼“å­˜åŠ é€Ÿåç»­æ„å»º
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # 7. ä½¿ç”¨ Trivy æ‰«æé•œåƒä¸­çš„æ¼æ´
      - name: ğŸ›¡ï¸ Scan for Vulnerabilities with Trivy
        uses: aquasecurity/trivy-action@0.24.0
        with:
          # ä½¿ç”¨å…ƒæ•°æ®æ­¥éª¤ç”Ÿæˆçš„ç¬¬ä¸€ä¸ªæ ‡ç­¾ä½œä¸ºæ‰«æç›®æ ‡
          image-ref: ${{ fromJSON(steps.meta.outputs.json).tags[0] }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH' # ä»…å…³æ³¨é«˜å±å’Œä¸¥é‡æ¼
